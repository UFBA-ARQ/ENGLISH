<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DET Mastery: Listening Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .glass-card { background: white; border: 1px solid #e2e8f0; }
        .level-btn.active { background-color: #4f46e5; color: white; border-color: #4f46e5; }
        
        .pulse-audio {
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        @keyframes pulse-ring {
            0% { transform: scale(.95); box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4); }
            70% { transform: scale(1); box-shadow: 0 0 0 15px rgba(79, 70, 229, 0); }
            100% { transform: scale(.95); box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
        }

        .loading-spinner { 
            border: 3px solid rgba(79, 70, 229, 0.1); 
            border-left-color: #4f46e5; 
            border-radius: 50%; width: 24px; height: 24px; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .hint-tag { transition: all 0.2s ease; cursor: pointer; }
        .hint-tag:hover { transform: translateY(-1px); background-color: #f8fafc; border-color: #4f46e5; color: #4f46e5; }
        
        input::placeholder { color: #cbd5e1; font-weight: 400; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 md:p-8">

    <div class="max-w-4xl w-full">
        <!-- Header & Level Selection -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-6">
            <div>
                <h1 class="text-3xl font-black text-slate-900 tracking-tight">DET Mastery <span class="text-indigo-600">Audio</span></h1>
                <p class="text-slate-500 font-medium text-sm">Ouve e completa o conectivo em falta.</p>
            </div>
            
            <div class="flex bg-white p-1 rounded-2xl shadow-sm border border-slate-200">
                <button onclick="changeLevel('B1')" id="btn-B1" class="level-btn px-4 py-2 rounded-xl text-xs font-black transition-all active">B1</button>
                <button onclick="changeLevel('B2')" id="btn-B2" class="level-btn px-4 py-2 rounded-xl text-xs font-black transition-all">B2</button>
                <button onclick="changeLevel('C1')" id="btn-C1" class="level-btn px-4 py-2 rounded-xl text-xs font-black transition-all">C1</button>
                <button onclick="changeLevel('C2')" id="btn-C2" class="level-btn px-4 py-2 rounded-xl text-xs font-black transition-all">C2</button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Main Content Area -->
            <div class="lg:col-span-2 flex flex-col gap-6">
                <div id="quiz-card" class="glass-card p-8 md:p-12 rounded-[2.5rem] shadow-xl flex flex-col items-center justify-center min-h-[500px] relative overflow-hidden">
                    
                    <div id="loader" class="hidden flex flex-col items-center gap-4">
                        <div class="loading-spinner"></div>
                        <p class="text-indigo-600 font-bold text-sm">A gerar novo desafio...</p>
                    </div>

                    <div id="question-ui" class="w-full flex flex-col items-center">
                        
                        <!-- Control Bar Above Play -->
                        <div class="flex items-center gap-4 mb-8">
                             <div class="flex items-center bg-slate-100 rounded-full px-3 py-1 gap-2">
                                <span class="text-[9px] font-black text-slate-400 uppercase">Velocidade</span>
                                <select id="speed-select" onchange="updateSpeed()" class="bg-transparent text-xs font-bold text-indigo-600 outline-none cursor-pointer">
                                    <option value="0.7">0.7x</option>
                                    <option value="0.85" selected>0.85x</option>
                                    <option value="1.0">1.0x</option>
                                </select>
                             </div>
                        </div>

                        <!-- Main Play & Action Buttons -->
                        <div class="flex items-center gap-6 mb-10">
                            <button id="main-play-btn" onclick="playAudio()" class="w-24 h-24 bg-indigo-600 text-white rounded-full flex items-center justify-center shadow-2xl shadow-indigo-200 hover:bg-indigo-700 transition-all pulse-audio" title="Ouvir Áudio">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M8 5v14l11-7z" />
                                </svg>
                            </button>
                            
                            <!-- Botão de Próxima Frase (Confirmar Resposta) -->
                            <button onclick="checkAnswer()" class="p-4 bg-indigo-50 text-indigo-600 rounded-full hover:bg-indigo-100 transition-all border border-indigo-100" title="Confirmar e Analisar">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                                </svg>
                            </button>
                        </div>

                        <!-- Hidden Text Option -->
                        <div class="mb-10 text-center w-full">
                            <button id="reveal-btn" onclick="togglePhraseVisibility()" class="text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-indigo-600 transition-colors flex items-center gap-2 mx-auto">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                                Revelar Frase Escrita
                            </button>
                            <p id="phrase-display" class="hidden mt-6 text-xl md:text-2xl font-bold text-slate-700 leading-relaxed max-w-lg mx-auto italic"></p>
                        </div>

                        <!-- Options Cloud -->
                        <div id="hints-container" class="flex flex-wrap justify-center gap-2.5 mb-10 max-w-md"></div>

                        <!-- Input Field -->
                        <div class="w-full max-w-sm">
                            <input type="text" id="answer-input" placeholder="O que ouviu no lugar do [gap]?" 
                                   class="w-full text-center text-xl p-5 border-b-4 border-slate-100 focus:border-indigo-500 outline-none bg-transparent transition-all font-black text-slate-800"
                                   autocomplete="off"
                                   onkeydown="if(event.key==='Enter') checkAnswer()">
                        </div>
                    </div>

                    <!-- Feedback Overlay -->
                    <div id="feedback-overlay" class="hidden absolute inset-0 z-20 flex flex-col items-center justify-center p-8 text-center bg-white/95 backdrop-blur-sm">
                        <div id="feedback-icon-container" class="w-20 h-20 rounded-full flex items-center justify-center mb-6 border-4">
                            <span id="feedback-icon" class="text-4xl"></span>
                        </div>
                        <h2 id="feedback-title" class="text-4xl font-black mb-4"></h2>
                        <div class="bg-slate-50 p-6 rounded-3xl mb-10 w-full max-w-md">
                            <div class="mb-4">
                                <p class="text-[10px] font-black text-slate-400 uppercase mb-1 tracking-widest">Frase em Inglês</p>
                                <p id="correct-answer-display" class="text-slate-700 font-bold leading-relaxed"></p>
                            </div>
                            <div class="pt-4 border-t border-slate-200">
                                <p class="text-[10px] font-black text-indigo-400 uppercase mb-1 tracking-widest">Tradução em Português</p>
                                <p id="translation-display" class="text-slate-500 italic text-sm font-medium leading-relaxed"></p>
                            </div>
                        </div>
                        <button onclick="fetchNewQuestion()" class="bg-indigo-600 text-white px-12 py-5 rounded-3xl font-black text-xl hover:bg-indigo-700 shadow-xl shadow-indigo-100 transition-all active:scale-95">
                            Próxima Frase
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stats & Sidebar -->
            <div class="flex flex-col gap-6">
                <!-- Progress Card -->
                <div class="glass-card p-8 rounded-[2.5rem] shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Meta do Nível</span>
                        <span id="streak-count" class="text-xl font-black text-indigo-600">0/5</span>
                    </div>
                    <div class="w-full bg-slate-100 h-4 rounded-full overflow-hidden">
                        <div id="progress-bar" class="bg-indigo-600 h-full transition-all duration-700" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Score Summary -->
                <div class="grid grid-cols-2 lg:grid-cols-1 gap-4">
                    <div class="glass-card p-6 rounded-[2rem] shadow-sm text-center">
                        <p class="text-[10px] text-slate-400 font-black uppercase mb-1">Acertos</p>
                        <p id="total-correct" class="text-4xl font-black text-slate-900">0</p>
                    </div>
                    <div class="glass-card p-6 rounded-[2rem] shadow-sm text-center">
                        <p class="text-[10px] text-slate-400 font-black uppercase mb-1">Nível Atual</p>
                        <p id="current-lvl-name" class="text-4xl font-black text-indigo-600">B1</p>
                    </div>
                </div>

                <!-- Settings -->
                <div class="glass-card p-6 rounded-[2.5rem] shadow-sm">
                    <button onclick="toggleSettings()" class="w-full text-left text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 flex justify-between items-center group">
                        Configurar API <span class="group-hover:rotate-45 transition-transform">⚙️</span>
                    </button>
                    <div id="settings-area" class="hidden flex flex-col gap-3">
                        <input type="password" id="api-key-input" placeholder="Google Gemini Key..." class="w-full p-4 rounded-2xl border border-slate-200 text-xs outline-none focus:ring-2 focus:ring-indigo-500/20">
                        <button onclick="saveApiKey()" class="bg-indigo-600 text-white py-3 rounded-2xl text-xs font-bold hover:bg-indigo-700 transition-all">Ativar</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        let apiKey = localStorage.getItem('det_mastery_api_key') || "";
        let currentLevel = "B1";
        let streak = 0;
        let totalCorrect = 0;
        let currentQuestion = null;
        let audioSpeed = 0.85;

        const levelData = {
            "B1": ["However", "Therefore", "Although", "Whereas"],
            "B2": ["Furthermore", "Nevertheless", "Consequently", "Despite"],
            "C1": ["Albeit", "Notwithstanding", "Conversely"],
            "C2": ["Accordingly", "By the same token"]
        };

        const levelOrder = ["B1", "B2", "C1", "C2"];

        window.onload = () => {
            document.getElementById('api-key-input').value = apiKey;
            fetchNewQuestion();
        };

        function changeLevel(level) {
            currentLevel = level;
            streak = 0;
            updateStats();
            document.querySelectorAll('.level-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${level}`).classList.add('active');
            document.getElementById('current-lvl-name').innerText = level;
            fetchNewQuestion();
        }

        function updateSpeed() {
            audioSpeed = parseFloat(document.getElementById('speed-select').value);
        }

        function toggleSettings() {
            document.getElementById('settings-area').classList.toggle('hidden');
        }

        function saveApiKey() {
            apiKey = document.getElementById('api-key-input').value.trim();
            localStorage.setItem('det_mastery_api_key', apiKey);
            toggleSettings();
            fetchNewQuestion();
        }

        async function fetchNewQuestion() {
            toggleLoader(true);
            resetUI();

            const pool = levelData[currentLevel];
            const randomSeed = Math.random().toString(36).substring(7);

            const systemPrompt = `Expert DET Tutor. Current User Level: ${currentLevel}. 
            Challenge: Listening completion for connectors.
            Connectors to use (CHOOSE ONE): [${pool.join(", ")}].
            Constraint: Create a formal/academic sentence.
            The word chosen MUST be the correct grammatical and logical fit.
            Return ONLY JSON:
            {
                "phraseWithBlank": "The sentence here with ________ as the gap.",
                "answer": "TheWord",
                "options": ["TheWord", "Wrong1", "Wrong2", "Wrong3"],
                "translation": "Tradução exata e natural da frase completa para Português de Portugal."
            }`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `New random ${currentLevel} listening challenge. Seed: ${randomSeed}` }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                if (!response.ok) throw new Error();
                const data = await response.json();
                const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                currentQuestion = JSON.parse(resultText);
                
                currentQuestion.options = currentQuestion.options.sort(() => Math.random() - 0.5);
                
                renderHints();
                document.getElementById('phrase-display').innerText = currentQuestion.phraseWithBlank;
                
                setTimeout(playAudio, 1000);

            } catch (error) {
                document.getElementById('phrase-display').innerText = "Erro. Verifica a tua API Key nas configurações.";
                document.getElementById('phrase-display').classList.remove('hidden');
            } finally {
                toggleLoader(false);
            }
        }

        function renderHints() {
            const container = document.getElementById('hints-container');
            container.innerHTML = "";
            currentQuestion.options.forEach(opt => {
                const span = document.createElement('span');
                span.className = "hint-tag px-5 py-2.5 bg-white border border-slate-200 text-slate-500 text-[10px] font-black rounded-2xl shadow-sm uppercase tracking-tighter";
                span.innerText = opt;
                span.onclick = () => {
                    if (!document.getElementById('answer-input').disabled) {
                        document.getElementById('answer-input').value = opt;
                        document.getElementById('answer-input').focus();
                    }
                };
                container.appendChild(span);
            });
        }

        function playAudio() {
            if (!currentQuestion) return;
            window.speechSynthesis.cancel();
            const audioText = currentQuestion.phraseWithBlank.replace("________", "[gap]");
            const utt = new SpeechSynthesisUtterance(audioText);
            utt.lang = 'en-US';
            utt.rate = audioSpeed; 
            window.speechSynthesis.speak(utt);
        }

        function togglePhraseVisibility() {
            const el = document.getElementById('phrase-display');
            el.classList.toggle('hidden');
        }

        function checkAnswer() {
            if (!document.getElementById('feedback-overlay').classList.contains('hidden')) return;

            const input = document.getElementById('answer-input').value.trim().toLowerCase();
            const correct = currentQuestion.answer.toLowerCase();
            const isCorrect = input === correct;

            const overlay = document.getElementById('feedback-overlay');
            const iconCont = document.getElementById('feedback-icon-container');
            const icon = document.getElementById('feedback-icon');
            const title = document.getElementById('feedback-title');
            const answerDisplay = document.getElementById('correct-answer-display');
            const translationDisplay = document.getElementById('translation-display');

            overlay.classList.remove('hidden');
            
            if (isCorrect) {
                streak++;
                totalCorrect++;
                icon.innerText = "✓";
                title.innerText = "Excelente!";
                title.className = "text-4xl font-black mb-4 text-emerald-600";
                iconCont.className = "w-20 h-20 rounded-full flex items-center justify-center mb-6 border-4 border-emerald-500 bg-emerald-50 text-emerald-500";
            } else {
                streak = 0;
                totalCorrect = 0; 
                icon.innerText = "✕";
                title.innerText = "Errado";
                title.className = "text-4xl font-black mb-4 text-rose-600";
                iconCont.className = "w-20 h-20 rounded-full flex items-center justify-center mb-6 border-4 border-rose-500 bg-rose-50 text-rose-500";
            }

            answerDisplay.innerText = currentQuestion.phraseWithBlank.replace('________', currentQuestion.answer);
            translationDisplay.innerText = currentQuestion.translation || "Tradução não disponível.";

            updateStats();
        }

        function updateStats() {
            document.getElementById('streak-count').innerText = `${streak}/5`;
            document.getElementById('total-correct').innerText = totalCorrect;
            document.getElementById('progress-bar').style.width = `${(streak / 5) * 100}%`;
        }

        function resetUI() {
            document.getElementById('answer-input').value = "";
            document.getElementById('answer-input').disabled = false;
            document.getElementById('phrase-display').classList.add('hidden');
            document.getElementById('feedback-overlay').classList.add('hidden');
            setTimeout(() => document.getElementById('answer-input').focus(), 100);
        }

        function toggleLoader(show) {
            document.getElementById('question-ui').classList.toggle('hidden', show);
            document.getElementById('loader').classList.toggle('hidden', !show);
        }
    </script>
</body>
</html>